<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title></title>
<meta charset=utf-8><meta name=description content="Ladder@Node.Startup
Node的结构
type Node struct {  
    Options            // current node options  
    ServiceAddr string // current server service address (RPC)  
  
    cluster   *cluster  
    handler   *LocalHandler  
    server    *grpc.Server  
    rpcClient *rpcClient  
  
    mu       sync.RWMutex  
    sessions map[int64]*session.Session  
  
    once          sync.Once  
    keepaliveExit chan struct{}  
}

type MemberServer interface {  
    HandleRequest(context.Context, *RequestMessage) (*MemberHandleResponse, error)  
    HandleNotify(context.Context, *NotifyMessage) (*MemberHandleResponse, error)  
    HandlePush(context.Context, *PushMessage) (*MemberHandleResponse, error)  
    HandleResponse(context.Context, *ResponseMessage) (*MemberHandleResponse, error)  
    NewMember(context.Context, *NewMemberRequest) (*NewMemberResponse, error)  
    DelMember(context.Context, *DelMemberRequest) (*DelMemberResponse, error)  
    SessionClosed(context.Context, *SessionClosedRequest) (*SessionClosedResponse, error)  
    CloseSession(context.Context, *CloseSessionRequest) (*CloseSessionResponse, error)  
}
Node实现了MemberServer接口
cluster的结构
type cluster struct {  
	// If cluster is not large enough, use slice is OK    
	currentNode *Node  
    rpcClient   *rpcClient  
  
    mu      sync.RWMutex  
    members []*Member  
}

type MasterServer interface {  
    Register(context.Context, *RegisterRequest) (*RegisterResponse, error)  
    Unregister(context.Context, *UnregisterRequest) (*UnregisterResponse, error)  
    Heartbeat(context.Context, *HeartbeatRequest) (*HeartbeatResponse, error)  
}
cluster实现了MasterServer接口。因此cluster拥有三个方法依次是
Register"><meta name=author content="map[email:axlrose.huang@gmail.com name:Axlrose]"><link rel=canonical href=https://echotrue.github.io/blog/game/nano/nano-new/><link rel=alternate type=application/rss+xml href=https://echotrue.github.io//index.xml title=AXLROSE><meta property="og:url" content="https://echotrue.github.io/blog/game/nano/nano-new/"><meta property="og:site_name" content="AXLROSE"><meta property="og:title" content="AXLROSE"><meta property="og:description" content="Node.Startup Node的结构 type Node struct { Options // current node options ServiceAddr string // current server service address (RPC) cluster *cluster handler *LocalHandler server *grpc.Server rpcClient *rpcClient mu sync.RWMutex sessions map[int64]*session.Session once sync.Once keepaliveExit chan struct{} } type MemberServer interface { HandleRequest(context.Context, *RequestMessage) (*MemberHandleResponse, error) HandleNotify(context.Context, *NotifyMessage) (*MemberHandleResponse, error) HandlePush(context.Context, *PushMessage) (*MemberHandleResponse, error) HandleResponse(context.Context, *ResponseMessage) (*MemberHandleResponse, error) NewMember(context.Context, *NewMemberRequest) (*NewMemberResponse, error) DelMember(context.Context, *DelMemberRequest) (*DelMemberResponse, error) SessionClosed(context.Context, *SessionClosedRequest) (*SessionClosedResponse, error) CloseSession(context.Context, *CloseSessionRequest) (*CloseSessionResponse, error) } Node实现了MemberServer接口
cluster的结构 type cluster struct { // If cluster is not large enough, use slice is OK currentNode *Node rpcClient *rpcClient mu sync.RWMutex members []*Member } type MasterServer interface { Register(context.Context, *RegisterRequest) (*RegisterResponse, error) Unregister(context.Context, *UnregisterRequest) (*UnregisterResponse, error) Heartbeat(context.Context, *HeartbeatRequest) (*HeartbeatResponse, error) } cluster实现了MasterServer接口。因此cluster拥有三个方法依次是 Register"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-11-26T14:22:41+00:00"><meta property="article:modified_time" content="2024-11-26T14:22:41+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://echotrue.github.io/blog/"},{"@type":"ListItem","position":2,"name":"","item":"https://echotrue.github.io/blog/game/nano/nano-new/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":"Node.Startup Node的结构 type Node struct { Options // current node options ServiceAddr string // current server service address (RPC) cluster *cluster handler *LocalHandler server *grpc.Server rpcClient *rpcClient mu sync.RWMutex sessions map[int64]*session.Session once sync.Once keepaliveExit chan struct{} } type MemberServer interface { HandleRequest(context.Context, *RequestMessage) (*MemberHandleResponse, error) HandleNotify(context.Context, *NotifyMessage) (*MemberHandleResponse, error) HandlePush(context.Context, *PushMessage) (*MemberHandleResponse, error) HandleResponse(context.Context, *ResponseMessage) (*MemberHandleResponse, error) NewMember(context.Context, *NewMemberRequest) (*NewMemberResponse, error) DelMember(context.Context, *DelMemberRequest) (*DelMemberResponse, error) SessionClosed(context.Context, *SessionClosedRequest) (*SessionClosedResponse, error) CloseSession(context.Context, *CloseSessionRequest) (*CloseSessionResponse, error) } Node实现了MemberServer接口\ncluster的结构 type cluster struct { // If cluster is not large enough, use slice is OK currentNode *Node rpcClient *rpcClient mu sync.RWMutex members []*Member } type MasterServer interface { Register(context.Context, *RegisterRequest) (*RegisterResponse, error) Unregister(context.Context, *UnregisterRequest) (*UnregisterResponse, error) Heartbeat(context.Context, *HeartbeatRequest) (*HeartbeatResponse, error) } cluster实现了MasterServer接口。因此cluster拥有三个方法依次是 Register\n","keywords":[],"articleBody":"Node.Startup Node的结构 type Node struct { Options // current node options ServiceAddr string // current server service address (RPC) cluster *cluster handler *LocalHandler server *grpc.Server rpcClient *rpcClient mu sync.RWMutex sessions map[int64]*session.Session once sync.Once keepaliveExit chan struct{} } type MemberServer interface { HandleRequest(context.Context, *RequestMessage) (*MemberHandleResponse, error) HandleNotify(context.Context, *NotifyMessage) (*MemberHandleResponse, error) HandlePush(context.Context, *PushMessage) (*MemberHandleResponse, error) HandleResponse(context.Context, *ResponseMessage) (*MemberHandleResponse, error) NewMember(context.Context, *NewMemberRequest) (*NewMemberResponse, error) DelMember(context.Context, *DelMemberRequest) (*DelMemberResponse, error) SessionClosed(context.Context, *SessionClosedRequest) (*SessionClosedResponse, error) CloseSession(context.Context, *CloseSessionRequest) (*CloseSessionResponse, error) } Node实现了MemberServer接口\ncluster的结构 type cluster struct { // If cluster is not large enough, use slice is OK currentNode *Node rpcClient *rpcClient mu sync.RWMutex members []*Member } type MasterServer interface { Register(context.Context, *RegisterRequest) (*RegisterResponse, error) Unregister(context.Context, *UnregisterRequest) (*UnregisterResponse, error) Heartbeat(context.Context, *HeartbeatRequest) (*HeartbeatResponse, error) } cluster实现了MasterServer接口。因此cluster拥有三个方法依次是 Register\nUnregister 参数req.ServiceAddr必须存在，遍历members找到ServiceAddr和参数req.ServiceAddr相同的成员，并且记录它的切片索引值。如果这个值小于0，说明该成员还未注册到master节点。直接返回错误。 然后通知已注册的节点更新他们的远程服务，首先剔除掉当前待移除的节点，然后剔除掉和集群的当前节点ServiceAddr地址相同的节点。这些节点是不需要通知的。 然后根据成员的ServiceAddr从rpcClient池中获取该成员节点的连接对象最后通过rpc调用该节点的DelMember方法更新已注册的服务。该方法主要是从节点的handler中删除对应的服务，从节点的集群中删除对应的节点数据。\nHeartbeat\n实例化node.cluster cluster的实例化比较简单，首先是将当前node赋值给cluster的currentNode字段。 如果当前节点是master节点的话还需要执行cluster.checkMemberHeartbeat()方法。该方法定义了一个定时器，这个定时器每过env.Heartbeat(init方法中默认是30秒)执行一次，如果cluster的currentNode不是master节点则停止定时器并推出当前协程。反之则执行check函数。\ncheck函数首先遍历集群的members字段，如果上次心跳时间距离当前时间超过120秒并且该member不是主节点则将当前member添加到unregisterMembers列表中,并在稍后依次卸载这些节点的服务。详细逻辑参考cluster.Unregister方法\n如果有定义Unregister的回调函数，则执行回调函数\n从集群的当前节点的handler中删除服务，并从结群的成员中删除该成员\n实例化node.handler并注册服务 type LocalHandler struct { localServices map[string]*component.Service // all registered service localHandlers map[string]*component.Handler // all handler method mu sync.RWMutex remoteServices map[string][]*clusterpb.MemberInfo pipeline pipeline.Pipeline currentNode *Node } 将components依次注册到handler。\n","wordCount":"1006","inLanguage":"en","datePublished":"2024-11-26T14:22:41Z","dateModified":"2024-11-26T14:22:41Z","author":{"@type":"Person","name":{"email":"axlrose.huang@gmail.com","name":"Axlrose"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https://echotrue.github.io/blog/game/nano/nano-new/"},"publisher":{"@type":"Organization","name":"AXLROSE","logo":{"@type":"ImageObject","url":"https://echotrue.github.io/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/style.css><link rel=stylesheet href=/css/main.min.b18e8501c4f9c51c7bc74c831f88a4705978246e383d68ba514a05459901ef6f.css integrity="sha256-sY6FAcT5xRx7x0yDH4ikcFl4JG44PWi6UUoFRZkB728=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/prism.min.ab059a12f053f9764c2b65f5e83ea3a2e77c9957e453e01e0478a8ab6b11109f.css><script src=/js/prism.min.4efeed559740892c1071317ffd1e799722e52463c486cfb182fdef01622950fc.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/blog>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/series>Series</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/book>Book</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1></h1></header><p><small>November 26, 2024&nbsp;· 1006 words&nbsp;· 3 min</small>
<small></small><p><div class=blog-toc><nav id=TableOfContents><ul><li><ul><li><a href=#nodestartup>Node.Startup</a></li></ul></li></ul></nav></div><section class=blog-content><h3 id=nodestartup>Node.Startup</h3><h4 id=node的结构>Node的结构</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Node</span> <span style=color:#66d9ef>struct</span> {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Options</span>            <span style=color:#75715e>// current node options  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ServiceAddr</span> <span style=color:#66d9ef>string</span> <span style=color:#75715e>// current server service address (RPC)  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cluster</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>cluster</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>handler</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>LocalHandler</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>server</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>Server</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rpcClient</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>rpcClient</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>       <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sessions</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>Session</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>once</span>          <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Once</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>keepaliveExit</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MemberServer</span> <span style=color:#66d9ef>interface</span> {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HandleRequest</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>RequestMessage</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>MemberHandleResponse</span>, <span style=color:#66d9ef>error</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HandleNotify</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>NotifyMessage</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>MemberHandleResponse</span>, <span style=color:#66d9ef>error</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HandlePush</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>PushMessage</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>MemberHandleResponse</span>, <span style=color:#66d9ef>error</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HandleResponse</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>ResponseMessage</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>MemberHandleResponse</span>, <span style=color:#66d9ef>error</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NewMember</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>NewMemberRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>NewMemberResponse</span>, <span style=color:#66d9ef>error</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DelMember</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>DelMemberRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>DelMemberResponse</span>, <span style=color:#66d9ef>error</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SessionClosed</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>SessionClosedRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>SessionClosedResponse</span>, <span style=color:#66d9ef>error</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CloseSession</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>CloseSessionRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>CloseSessionResponse</span>, <span style=color:#66d9ef>error</span>)  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Node实现了MemberServer接口</p><h4 id=cluster的结构>cluster的结构</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>cluster</span> <span style=color:#66d9ef>struct</span> {  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If cluster is not large enough, use slice is OK    
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>currentNode</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Node</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rpcClient</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>rpcClient</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>      <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>members</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>Member</span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MasterServer</span> <span style=color:#66d9ef>interface</span> {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>RegisterRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RegisterResponse</span>, <span style=color:#66d9ef>error</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>UnregisterRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>UnregisterResponse</span>, <span style=color:#66d9ef>error</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Heartbeat</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>HeartbeatRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>HeartbeatResponse</span>, <span style=color:#66d9ef>error</span>)  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>cluster实现了MasterServer接口。因此cluster拥有三个方法依次是
<strong>Register</strong></p><p><strong>Unregister</strong>
参数req.ServiceAddr必须存在，遍历members找到ServiceAddr和参数req.ServiceAddr相同的成员，并且记录它的切片索引值。如果这个值小于0，说明该成员还未注册到master节点。直接返回错误。
然后通知已注册的节点更新他们的远程服务，首先剔除掉当前待移除的节点，然后剔除掉和集群的当前节点ServiceAddr地址相同的节点。这些节点是不需要通知的。
然后根据成员的ServiceAddr从rpcClient池中获取该成员节点的连接对象最后通过rpc调用该节点的DelMember方法更新已注册的服务。该方法主要是从节点的handler中删除对应的服务，从节点的集群中删除对应的节点数据。</p><p><strong>Heartbeat</strong></p><h4 id=实例化nodecluster>实例化node.cluster</h4><p>cluster的实例化比较简单，首先是将当前node赋值给cluster的currentNode字段。
如果当前节点是master节点的话还需要执行cluster.checkMemberHeartbeat()方法。该方法定义了一个定时器，这个定时器每过env.Heartbeat(init方法中默认是30秒)执行一次，如果cluster的currentNode不是master节点则停止定时器并推出当前协程。反之则执行check函数。</p><p>check函数首先遍历集群的members字段，如果上次心跳时间距离当前时间超过120秒并且该member不是主节点则将当前member添加到unregisterMembers列表中,并在稍后依次卸载这些节点的服务。详细逻辑参考cluster.Unregister方法</p><p>如果有定义Unregister的回调函数，则执行回调函数</p><p>从集群的当前节点的handler中删除服务，并从结群的成员中删除该成员</p><h4 id=实例化nodehandler并注册服务>实例化node.handler并注册服务</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LocalHandler</span> <span style=color:#66d9ef>struct</span> {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>localServices</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>component</span>.<span style=color:#a6e22e>Service</span> <span style=color:#75715e>// all registered service  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>localHandlers</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>component</span>.<span style=color:#a6e22e>Handler</span> <span style=color:#75715e>// all handler method  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>             <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>remoteServices</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#f92672>*</span><span style=color:#a6e22e>clusterpb</span>.<span style=color:#a6e22e>MemberInfo</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pipeline</span>    <span style=color:#a6e22e>pipeline</span>.<span style=color:#a6e22e>Pipeline</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentNode</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Node</span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>将components依次注册到handler。</p></section><div class=paginator><a class=prev href=https://echotrue.github.io/blog/101/backend/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span></span></a>
<a class=next href=https://echotrue.github.io/blog/101/bit-oprations/><span>Bit Oprations</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://echotrue.github.io/>AXLROSE</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
Theme by
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>