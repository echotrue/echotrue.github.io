<!doctype html><html lang=zh><head><meta name=viewport content="width=device-width,initial-scale=1"><title>再读Context包</title>
<meta charset=utf-8><meta name=description content="Ladder@Context接口 type Context interface { Deadline() (deadline time.Time, ok bool) Done() <-chan struct{} Err() error Value(key any) any } Deadline()返回一个截止时间，到了这个时间后正在进行的工作将会终止。这意味着当"><meta name=author content="Axlrose"><link rel=canonical href=https://echotrue.github.io/golang/read-context-again/><link rel=alternate type=application/rss+xml href=https://echotrue.github.io//index.xml title=AXLROSE><meta property="og:url" content="https://echotrue.github.io/golang/read-context-again/"><meta property="og:site_name" content="AXLROSE"><meta property="og:title" content="再读Context包"><meta property="og:description" content="Context接口 type Context interface { Deadline() (deadline time.Time, ok bool) Done() <-chan struct{} Err() error Value(key any) any } Deadline()返回一个截止时间，到了这个时间后正在进行的工作将会终止。这意味着当"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="golang"><meta property="article:published_time" content="2024-05-17T16:36:37+08:00"><meta property="article:modified_time" content="2024-05-17T16:36:37+08:00"><meta property="article:tag" content="Context"><meta property="og:see_also" content="https://echotrue.github.io/golang/context/"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"再读Context包","item":"https://echotrue.github.io/golang/read-context-again/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"再读Context包","name":"再读Context包","description":"Context接口 type Context interface { Deadline() (deadline time.Time, ok bool) Done() \u0026lt;-chan struct{} Err() error Value(key any) any } Deadline()返回一个截止时间，到了这个时间后正在进行的工作将会终止。这意味着当","keywords":["Context"],"articleBody":"Context接口 type Context interface { Deadline() (deadline time.Time, ok bool) Done() \u003c-chan struct{} Err() error Value(key any) any } Deadline()返回一个截止时间，到了这个时间后正在进行的工作将会终止。这意味着当前上下文应该被取消。没有设置截止时间则第二个返回值为false，多次调用该方法返回相同的结果。 Done()返回一个已经关闭的chan此时正在进行的工作将会终止。这意味着当前上下文应该被取消。如果这个上下文永远不能被取消，Done返回nil。多次调用该方法返回相同的结果。该chan的关闭动作可能会在cancel函数返回后异步的发生。 Err()返回nil当Done返回的通道未关闭时，反之则返回非空的错误。 Value() 内置上下文 //基础ctx type emptyCtx struct{} type backgroundCtx struct{ emptyCtx } type todoCtx struct{ emptyCtx } //可取消的ctx type cancelCtx struct { Context mu sync.Mutex // protects following fields done atomic.Value // of chan struct{}, created lazily, closed by first cancel call children map[canceler]struct{} // set to nil by the first cancel call err error // set to non-nil by the first cancel call cause error // set to non-nil by the first cancel call } type afterFuncCtx struct { cancelCtx once sync.Once // either starts running f or stops f from running f func() } type timerCtx struct { cancelCtx timer *time.Timer // Under cancelCtx.mu. deadline time.Time } type stopCtx struct { Context stop func() bool } type valueCtx struct { Context key, val any } type withoutCancelCtx struct { c Context } emptyCtx是一个永远不会被取消，没有值，没有截止时间的上下文。backgroundCtx和todoCtx均是基于它而存在。通常将backgroundCtx作为根节点。 cancelCtx是一个带取消的上下文，afterFuncCtx和timerCtx都是基于它实现的 stopCtx valueCtx withoutCancelCtx 可取消的cancelCtx 创建一个带取消的上下文： func withCancel(parent Context) *cancelCtx { if parent == nil { panic(\"cannot create context from nil parent\") } c := \u0026cancelCtx{} c.propagateCancel(parent, c) return c } propagateCancel() func (c *cancelCtx) propagateCancel(parent Context, child canceler) { c.Context = parent done := parent.Done() if done == nil { return // parent is never canceled } select { case \u003c-done: // parent is already canceled child.cancel(false, parent.Err(), Cause(parent)) return default: } if p, ok := parentCancelCtx(parent); ok { // parent is a *cancelCtx, or derives from one. p.mu.Lock() if p.err != nil { // parent has already been canceled child.cancel(false, p.err, p.cause) } else { if p.children == nil { p.children = make(map[canceler]struct{}) } p.children[child] = struct{}{} } p.mu.Unlock() return } if a, ok := parent.(afterFuncer); ok { // parent implements an AfterFunc method. c.mu.Lock() stop := a.AfterFunc(func() { child.cancel(false, parent.Err(), Cause(parent)) }) c.Context = stopCtx{ Context: parent, stop: stop, } c.mu.Unlock() return } goroutines.Add(1) go func() { select { case \u003c-parent.Done(): child.cancel(false, parent.Err(), Cause(parent)) case \u003c-child.Done(): } }() } 将parent赋值给当前cancelCtx的Context字段 获取父上下文的Done通道，如果该通道为空，说明父上下文是不可取消的。则无需执行后续逻辑。 如果父上下文是cancelCtx，则通过err判断父上下文是否被取消。如果父级已被取消那么作为子级的当前上下文也应该执行cancel操作来取消。如果父级没有被取消，则需要将当前上下文附加到父级的children字段中,以便父级取消后依次取消所有子级。 如果父上下文实现了afterFuncer,则组合一个stopCtx并赋值给当前cancelCtx的Context字段. 既不是cancelCtx又没有实现afterFuncer则启动一个go程来分别监听父上下文和子上下文的状态，如果父上下文被取消则取消子上下文。如果子上下文被取消则直接跳过,因为不影响父级。 这里监听父上下文done的信号是因为当前parent并不是一个cancel类型的上下文，这在前面的parentCancelCtx函数中已经被验证过，因此这个parent没有children，无法像cancelCtx那样取消子级上下文。因此，在这里监听parent的done信号来确定是否需要取消子级。 这里监听自己是因为，如果自己比父级先取消，那么该goroutine就可以直接退出了，防止内存溢出。 cancelCtx.cancel() func (c *cancelCtx) cancel(removeFromParent bool, err, cause error) { if err == nil { panic(\"context: internal error: missing cancel error\") } if cause == nil { cause = err } c.mu.Lock() if c.err != nil { c.mu.Unlock() return // already canceled } c.err = err c.cause = cause d, _ := c.done.Load().(chan struct{}) if d == nil { c.done.Store(closedchan) } else { close(d) } for child := range c.children { // NOTE: acquiring the child's lock while holding parent's lock. child.cancel(false, err, cause) } c.children = nil c.mu.Unlock() if removeFromParent { removeChild(c.Context, c) } } cancel函数有三个入参，removeFromParent指是否要将当前上下文从其父级的children列表中移除，err和cause是取消的错误信息描述。 加载cancelCtx中done的值，done是一个原子变量，其值是一个无缓冲chan struct{}。如果done没有值则为其赋值为closedchan，closedchan也是一个无缓冲的chan struct{},且在init函数中被close。如果done有值则close这个chan struct{}。一旦关闭了该通道，ctx.Done()就能接收到值，然后就可以释放go程了。 依次取消子级上下文 从父级中移除当前上下文 cancelCtx.Done() func (c *cancelCtx) Done() \u003c-chan struct{} { d := c.done.Load() if d != nil { return d.(chan struct{}) } c.mu.Lock() defer c.mu.Unlock() d = c.done.Load() if d == nil { d = make(chan struct{}) c.done.Store(d) } return d.(chan struct{}) } 加载cancelCtx中的done值,如果有值直接返回 加锁，然后再次加在cancelCtx中的done值,如果done为nil,则初始化done的值。此处使用了双重检测机制保证done只被初始化一次。 parentCancelCtx() func parentCancelCtx(parent Context) (*cancelCtx, bool) { done := parent.Done() if done == closedchan || done == nil { return nil, false } p, ok := parent.Value(\u0026cancelCtxKey).(*cancelCtx) if !ok { return nil, false } pdone, _ := p.done.Load().(chan struct{}) if pdone != done { return nil, false } return p, true } // cancelCtx的Value方法 func (c *cancelCtx) Value(key any) any { if key == \u0026cancelCtxKey { return c } return value(c.Context, key) } // valueCtx的Value方法 func (c *valueCtx) Value(key any) any { if c.key == key { return c.val } return value(c.Context, key) } 查找并返回parent的底层cancelCtx。 在context包中只有cancelCtx、emptyCtx、withoutCancelCtx是直接实现了Done方法的,其中只有cancelCtx是实现了非nil的Done方法的。其他的诸如valueCtx、timeCtx等都是通过嵌入实现的，所以其他ctx调用Done方法时实际是调用的cancelCtx、emptyCtx、withoutCancelCtx这些ctx的Done方法。因此done := parent.Done()其实是从parent的ctx树向上找到的第一个实现了Done方法的父级ctx，这里我们暂时用A称呼这个ctx。当done == nil时说明A不是cancelCtx。当done!=nil时说明A是cancelCtx。如果在ctx树中有自定义的context且也实现了Done方法，A也可能是自定义的context parent.Value(\u0026cancelCtxKey).(*cancelCtx)查找ctx树中的第一个cancelCtx。这里将变量cancelCtxKey的内存地址作为参数传递给parent的Value方法。假设parent是cancelCtx直接将parent赋值给p，假设parent不是cancelCtx而是其他诸如valueCtx，则将parent的parent和key作为参数传递给value()来向上递归查找key对应值。参考value()方法 如果parent的上下文树中找到了cancelCtx，则取其done值。然后与前面parent的done值对比，如果他们不相等，说明当前上下文树中第一个实现Done的实例不是cancelCtx。反之，直接返回找到的这个cancelCtx value() func value(c Context, key any) any { for { switch ctx := c.(type) { case *valueCtx: if key == ctx.key { return ctx.val } c = ctx.Context case *cancelCtx: if key == \u0026cancelCtxKey { return c } c = ctx.Context case withoutCancelCtx: if key == \u0026cancelCtxKey { // This implements Cause(ctx) == nil // when ctx is created using WithoutCancel. return nil } c = ctx.c case *timerCtx: if key == \u0026cancelCtxKey { return \u0026ctx.cancelCtx } c = ctx.Context case backgroundCtx, todoCtx: return nil default: return c.Value(key) } } } 返回绑定在c上下文树上的key的值。\n如果c是valueCtx则直接根据key获取对应值，如果key不存在则向上从c的parent中查找key对应的值 如果c是cancelCtx则判断key是否是cancelCtxKey如果是则返回cancelCtx本身，反之向上从c的parent中查找key对应的值 如果c是withoutCancelCtx，则判断key是否是cancelCtx如果是则返回nil，反之向上从parent中查找 如果c是timerCtx，逻辑同cancelCtx 如果c是backgroundCtx或者todoCtx则直接返回nil 默认从c中取key对应的值 ","wordCount":"3074","inLanguage":"zh","datePublished":"2024-05-17T16:36:37+08:00","dateModified":"2024-05-17T16:36:37+08:00","author":{"@type":"Person","name":"Axlrose"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://echotrue.github.io/golang/read-context-again/"},"publisher":{"@type":"Organization","name":"AXLROSE","logo":{"@type":"ImageObject","url":"https://echotrue.github.io/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/style.css><link rel=stylesheet href=/css/main.min.577e48febdf10d4dae6762f6211106404b18fa4dcfbb094391e62c58786eb335.css integrity="sha256-V35I/r3xDU2uZ2L2IREGQEsY+k3PuwlDkeYsWHhuszU=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/atom-one-dark.min.d51fd0897056947c1a907d5753da4b37e67f6c13b4ec4c836708e028a1b5687a.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/game>Game</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/golang>Golang</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/art>生活</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>历史</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>标签</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>再读Context包</h1></header><p><small>2024年5月17日&nbsp;· 3074 字&nbsp;· 7 分钟</small>
<small>·
<a href=https://echotrue.github.io/tags/context/>Context</a></small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#context接口>Context接口</a></li><li><a href=#内置上下文>内置上下文</a></li><li><a href=#可取消的cancelctx>可取消的cancelCtx</a><ul><li></li></ul></li></ul></nav></div><section class=blog-content><h2 id=context接口>Context接口</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Context</span> <span style=color:#66d9ef>interface</span> {  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Deadline</span>() (<span style=color:#a6e22e>deadline</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#a6e22e>ok</span> <span style=color:#66d9ef>bool</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Done</span>() <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Err</span>() <span style=color:#66d9ef>error</span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>key</span> <span style=color:#a6e22e>any</span>) <span style=color:#a6e22e>any</span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>Deadline()</code>返回一个截止时间，到了这个时间后正在进行的工作将会终止。这意味着当前上下文应该被取消。没有设置截止时间则第二个返回值为<code>false</code>，多次调用该方法返回相同的结果。</li><li><code>Done()</code>返回一个已经关闭的<code>chan</code>此时正在进行的工作将会终止。这意味着当前上下文应该被取消。如果这个上下文永远不能被取消，<code>Done</code>返回<code>nil</code>。多次调用该方法返回相同的结果。该<code>chan</code>的关闭动作可能会在<code>cancel</code>函数返回后异步的发生。</li><li><code>Err()</code>返回<code>nil</code>当<code>Done</code>返回的通道未关闭时，反之则返回非空的错误。</li><li><code>Value()</code></li></ul><h2 id=内置上下文>内置上下文</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//基础ctx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>emptyCtx</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>backgroundCtx</span> <span style=color:#66d9ef>struct</span>{ <span style=color:#a6e22e>emptyCtx</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>todoCtx</span> <span style=color:#66d9ef>struct</span>{ <span style=color:#a6e22e>emptyCtx</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//可取消的ctx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>cancelCtx</span> <span style=color:#66d9ef>struct</span> {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Context</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>          <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>            <span style=color:#75715e>// protects following fields  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>done</span>        <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Value</span>          <span style=color:#75715e>// of chan struct{}, created lazily, closed by first cancel call    
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>children</span>    <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>canceler</span>]<span style=color:#66d9ef>struct</span>{} <span style=color:#75715e>// set to nil by the first cancel call    
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>err</span>         <span style=color:#66d9ef>error</span>                 <span style=color:#75715e>// set to non-nil by the first cancel call    
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cause</span>       <span style=color:#66d9ef>error</span>                 <span style=color:#75715e>// set to non-nil by the first cancel call
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>afterFuncCtx</span> <span style=color:#66d9ef>struct</span> {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cancelCtx</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>once</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Once</span> <span style=color:#75715e>// either starts running f or stops f from running    f    func()  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>timerCtx</span> <span style=color:#66d9ef>struct</span> {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cancelCtx</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timer</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Timer</span> <span style=color:#75715e>// Under cancelCtx.mu.  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>deadline</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>stopCtx</span> <span style=color:#66d9ef>struct</span> {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Context</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stop</span> <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>bool</span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>valueCtx</span> <span style=color:#66d9ef>struct</span> {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Context</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>val</span> <span style=color:#a6e22e>any</span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>withoutCancelCtx</span> <span style=color:#66d9ef>struct</span> {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span> <span style=color:#a6e22e>Context</span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>emptyCtx是一个永远不会被取消，没有值，没有截止时间的上下文。backgroundCtx和todoCtx均是基于它而存在。通常将backgroundCtx作为根节点。</li><li>cancelCtx是一个带取消的上下文，afterFuncCtx和timerCtx都是基于它实现的</li><li>stopCtx</li><li>valueCtx</li><li>withoutCancelCtx</li></ul><h2 id=可取消的cancelctx>可取消的cancelCtx</h2><h4 id=创建一个带取消的上下文>创建一个带取消的上下文：</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>withCancel</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>parent</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {  
</span></span><span style=display:flex><span>       panic(<span style=color:#e6db74>&#34;cannot create context from nil parent&#34;</span>)  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cancelCtx</span>{}  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>propagateCancel</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>c</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h6 id=propagatecancel>propagateCancel()</h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>) <span style=color:#a6e22e>propagateCancel</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>child</span> <span style=color:#a6e22e>canceler</span>) {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span> = <span style=color:#a6e22e>parent</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Done</span>()  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>done</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#75715e>// parent is never canceled  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>:  
</span></span><span style=display:flex><span>       <span style=color:#75715e>// parent is already canceled  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Err</span>(), <span style=color:#a6e22e>Cause</span>(<span style=color:#a6e22e>parent</span>))  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parentCancelCtx</span>(<span style=color:#a6e22e>parent</span>); <span style=color:#a6e22e>ok</span> {  
</span></span><span style=display:flex><span>       <span style=color:#75715e>// parent is a *cancelCtx, or derives from one.  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {  
</span></span><span style=display:flex><span>          <span style=color:#75715e>// parent has already been canceled  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>cause</span>)  
</span></span><span style=display:flex><span>       } <span style=color:#66d9ef>else</span> {  
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>children</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {  
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>children</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>canceler</span>]<span style=color:#66d9ef>struct</span>{})  
</span></span><span style=display:flex><span>          }          
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>children</span>[<span style=color:#a6e22e>child</span>] = <span style=color:#66d9ef>struct</span>{}{}  
</span></span><span style=display:flex><span>       }       
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parent</span>.(<span style=color:#a6e22e>afterFuncer</span>); <span style=color:#a6e22e>ok</span> {  
</span></span><span style=display:flex><span>       <span style=color:#75715e>// parent implements an AfterFunc method.  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()  
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>stop</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>AfterFunc</span>(<span style=color:#66d9ef>func</span>() {  
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Err</span>(), <span style=color:#a6e22e>Cause</span>(<span style=color:#a6e22e>parent</span>))  
</span></span><span style=display:flex><span>       })       
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span> = <span style=color:#a6e22e>stopCtx</span>{  
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Context</span>: <span style=color:#a6e22e>parent</span>,  
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>stop</span>:    <span style=color:#a6e22e>stop</span>,  
</span></span><span style=display:flex><span>       }       
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>goroutines</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>select</span> {  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Done</span>():  
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Err</span>(), <span style=color:#a6e22e>Cause</span>(<span style=color:#a6e22e>parent</span>))  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>Done</span>():  
</span></span><span style=display:flex><span>       }  
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>将<code>parent</code>赋值给当前<code>cancelCtx</code>的<code>Context</code>字段</li><li>获取父上下文的<code>Done</code>通道，如果该通道为空，说明父上下文是不可取消的。则无需执行后续逻辑。</li><li>如果父上下文是<code>cancelCtx</code>，则通过err判断父上下文是否被取消。如果父级已被取消那么作为子级的当前上下文也应该执行<code>cancel</code>操作来取消。如果父级没有被取消，则需要将当前上下文附加到父级的<code>children</code>字段中,以便父级取消后依次取消所有子级。</li><li>如果父上下文实现了<code>afterFuncer</code>,则组合一个<code>stopCtx</code>并赋值给当前<code>cancelCtx</code>的<code>Context</code>字段.</li><li>既不是<code>cancelCtx</code>又没有实现<code>afterFuncer</code>则启动一个go程来分别监听父上下文和子上下文的状态，如果父上下文被取消则取消子上下文。如果子上下文被取消则直接跳过,因为不影响父级。<ul><li>这里监听父上下文done的信号是因为当前parent并不是一个cancel类型的上下文，这在前面的<code>parentCancelCtx</code>函数中已经被验证过，因此这个parent没有children，无法像cancelCtx那样取消子级上下文。因此，在这里监听parent的done信号来确定是否需要取消子级。</li><li>这里监听自己是因为，如果自己比父级先取消，那么该goroutine就可以直接退出了，防止内存溢出。</li></ul></li></ul><h6 id=cancelctxcancel>cancelCtx.cancel()</h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>) <span style=color:#a6e22e>cancel</span>(<span style=color:#a6e22e>removeFromParent</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>cause</span> <span style=color:#66d9ef>error</span>) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {  
</span></span><span style=display:flex><span>       panic(<span style=color:#e6db74>&#34;context: internal error: missing cancel error&#34;</span>)  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cause</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {  
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cause</span> = <span style=color:#a6e22e>err</span>  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {  
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#75715e>// already canceled  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>err</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cause</span> = <span style=color:#a6e22e>cause</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>d</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span>.<span style=color:#a6e22e>Load</span>().(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {  
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>closedchan</span>)  
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {  
</span></span><span style=display:flex><span>       close(<span style=color:#a6e22e>d</span>)  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>child</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>children</span> {  
</span></span><span style=display:flex><span>       <span style=color:#75715e>// NOTE: acquiring the child&#39;s lock while holding parent&#39;s lock.  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>cause</span>)  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>children</span> = <span style=color:#66d9ef>nil</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>removeFromParent</span> {  
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>removeChild</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>c</span>)  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>cancel函数有三个入参，<code>removeFromParent</code>指是否要将当前上下文从其父级的children列表中移除，err和cause是取消的错误信息描述。</li><li>加载cancelCtx中done的值，done是一个原子变量，其值是一个无缓冲chan struct{}。如果done没有值则为其赋值为closedchan，closedchan也是一个无缓冲的chan struct{},且在init函数中被close。如果done有值则close这个chan struct{}。一旦关闭了该通道，ctx.Done()就能接收到值，然后就可以释放go程了。</li><li>依次取消子级上下文</li><li>从父级中移除当前上下文</li></ul><h6 id=cancelctxdone>cancelCtx.Done()</h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>) <span style=color:#a6e22e>Done</span>() <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{} {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span>.<span style=color:#a6e22e>Load</span>()  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>.(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>d</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span>.<span style=color:#a6e22e>Load</span>()  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {  
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>d</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})  
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>d</span>)  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>.(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>加载cancelCtx中的done值,如果有值直接返回</li><li>加锁，然后再次加在cancelCtx中的done值,如果done为nil,则初始化done的值。此处使用了双重检测机制保证done只被初始化一次。</li></ul><h6 id=parentcancelctx>parentCancelCtx()</h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>parentCancelCtx</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>, <span style=color:#66d9ef>bool</span>) {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Done</span>()  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>done</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>closedchan</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>done</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>false</span>  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cancelCtxKey</span>).(<span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>false</span>  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pdone</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>done</span>.<span style=color:#a6e22e>Load</span>().(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pdone</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>done</span> {  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>false</span>  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>p</span>, <span style=color:#66d9ef>true</span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// cancelCtx的Value方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>) <span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>key</span> <span style=color:#a6e22e>any</span>) <span style=color:#a6e22e>any</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cancelCtxKey</span> {  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>value</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>key</span>)  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// valueCtx的Value方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>valueCtx</span>) <span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>key</span> <span style=color:#a6e22e>any</span>) <span style=color:#a6e22e>any</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>key</span> {  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>val</span>  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>value</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>key</span>)  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>查找并返回parent的底层cancelCtx。</li><li>在context包中只有cancelCtx、emptyCtx、withoutCancelCtx是直接实现了Done方法的,其中只有cancelCtx是实现了非nil的Done方法的。其他的诸如valueCtx、timeCtx等都是通过嵌入实现的，所以其他ctx调用Done方法时实际是调用的cancelCtx、emptyCtx、withoutCancelCtx这些ctx的Done方法。因此<code>done := parent.Done()</code>其实是从parent的ctx树向上找到的第一个实现了Done方法的父级ctx，这里我们暂时用A称呼这个ctx。当done == nil时说明A不是cancelCtx。当done!=nil时说明A是cancelCtx。如果在ctx树中有自定义的context且也实现了Done方法，A也可能是自定义的context</li><li><code>parent.Value(&amp;cancelCtxKey).(*cancelCtx)</code>查找ctx树中的第一个cancelCtx。这里将变量cancelCtxKey的内存地址作为参数传递给parent的Value方法。假设parent是cancelCtx直接将parent赋值给p，假设parent不是cancelCtx而是其他诸如valueCtx，则将parent的parent和key作为参数传递给<code>value()</code>来向上递归查找key对应值。参考<a href=/golang/read-context-again/#value()>value()方法</a></li><li>如果parent的上下文树中找到了cancelCtx，则取其done值。然后与前面parent的done值对比，如果他们不相等，说明当前上下文树中第一个实现Done的实例不是cancelCtx。反之，直接返回找到的这个cancelCtx</li></ul><h6 id=value>value()</h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>value</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>key</span> <span style=color:#a6e22e>any</span>) <span style=color:#a6e22e>any</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.(<span style=color:#66d9ef>type</span>) {  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>valueCtx</span>:  
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>key</span> {  
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>val</span>  
</span></span><span style=display:flex><span>          }  
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>c</span> = <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Context</span>  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>:  
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cancelCtxKey</span> {  
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>  
</span></span><span style=display:flex><span>          }  
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>c</span> = <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Context</span>  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>withoutCancelCtx</span>:  
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cancelCtxKey</span> {  
</span></span><span style=display:flex><span>             <span style=color:#75715e>// This implements Cause(ctx) == nil  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             <span style=color:#75715e>// when ctx is created using WithoutCancel.             
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>  
</span></span><span style=display:flex><span>          }  
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>c</span> = <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>c</span>  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>timerCtx</span>:  
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>==</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cancelCtxKey</span> {  
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>cancelCtx</span>  
</span></span><span style=display:flex><span>          }  
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>c</span> = <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Context</span>  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>backgroundCtx</span>, <span style=color:#a6e22e>todoCtx</span>:  
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>  
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>default</span>:  
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>key</span>)  
</span></span><span style=display:flex><span>       }    
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>返回绑定在c上下文树上的key的值。</p><ul><li>如果c是valueCtx则直接根据key获取对应值，如果key不存在则向上从c的parent中查找key对应的值</li><li>如果c是cancelCtx则判断key是否是cancelCtxKey如果是则返回cancelCtx本身，反之向上从c的parent中查找key对应的值</li><li>如果c是withoutCancelCtx，则判断key是否是cancelCtx如果是则返回nil，反之向上从parent中查找</li><li>如果c是timerCtx，逻辑同cancelCtx</li><li>如果c是backgroundCtx或者todoCtx则直接返回nil</li><li>默认从c中取key对应的值</li></ul></section><div class=paginator><a class=next href=https://echotrue.github.io/golang/struct-interface/><span>Struct Interface</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=related-resources></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://echotrue.github.io/>AXLROSE</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
Theme by
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>